<!DOCTYPE html>
<html lang="en" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NoteDecs - Secure Note Taking</title>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* NoteDecs - Premium Note-Taking App CSS */
        :root {
            /* Enhanced Color System */
            --primary: #4361ee;
            /* Royal Blue */
            --primary-light: #e6e9ff;
            --primary-dark: #3a56d4;

            --secondary: #7209b7;
            /* Purple */
            --secondary-light: #f3e5ff;

            --accent: #f72585;
            /* Pink */
            --accent-light: #ffebf3;

            --success: #4cc9f0;
            /* Sky Blue */
            --success-light: #e6f7ff;

            --warning: #f8961e;
            /* Orange */
            --warning-light: #fff3e6;

            --danger: #ef233c;
            /* Red */
            --danger-light: #ffebee;

            /* Neutral Palette */
            --white: #ffffff;
            --gray-50: #f8f9fa;
            --gray-100: #f1f3f5;
            --gray-200: #e9ecef;
            --gray-300: #dee2e6;
            --gray-400: #ced4da;
            --gray-500: #adb5bd;
            --gray-600: #868e96;
            --gray-700: #495057;
            --gray-800: #343a40;
            --gray-900: #212529;
            --black: #121212;

            /* Text Colors */
            --text-primary: var(--gray-900);
            --text-secondary: var(--gray-600);
            --text-tertiary: var(--gray-500);
            --text-on-color: var(--white);

            /* Backgrounds */
            --bg-primary: var(--white);
            --bg-secondary: var(--gray-50);
            --bg-tertiary: var(--gray-100);
            --bg-elevated: var(--white);

            /* Borders */
            --border-light: var(--gray-200);
            --border-medium: var(--gray-300);
            --border-dark: var(--gray-400);

            /* Shadows */
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.04);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);

            /* Radius */
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
            --radius-full: 9999px;

            /* Spacing */
            --space-xs: 4px;
            --space-sm: 8px;
            --space-md: 16px;
            --space-lg: 24px;
            --space-xl: 32px;
            --space-xxl: 48px;

            /* Typography */
            --font-sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            --font-mono: 'SF Mono', 'Roboto Mono', Menlo, monospace;
            --text-xs: 0.75rem;
            --text-sm: 0.875rem;
            --text-base: 1rem;
            --text-lg: 1.125rem;
            --text-xl: 1.25rem;
            --text-2xl: 1.5rem;
            --text-3xl: 1.875rem;
            --text-4xl: 2.25rem;

            /* Transitions */
            --transition-fast: 0.15s ease;
            --transition-normal: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 0.5s cubic-bezier(0.4, 0, 0.2, 1);

            /* Z-index */
            --z-index-dropdown: 100;
            --z-index-sticky: 200;
            --z-index-fixed: 300;
            --z-index-modal: 400;
            --z-index-popover: 500;
            --z-index-tooltip: 600;
        }

        /* Dark Theme */
        [data-theme="dark"] {
            --primary: #4895ef;
            --primary-light: #1a365d;

            --text-primary: var(--gray-100);
            --text-secondary: var(--gray-400);
            --text-tertiary: var(--gray-600);

            --bg-primary: var(--gray-900);
            --bg-secondary: var(--gray-800);
            --bg-tertiary: var(--gray-700);
            --bg-elevated: var(--gray-800);

            --border-light: var(--gray-700);
            --border-medium: var(--gray-600);
            --border-dark: var(--gray-500);

            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.4), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
        }

        /* OLED Theme */
        [data-theme="black"] {
            --bg-primary: var(--black);
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #2a2a2a;
            --bg-elevated: #1a1a1a;

            --border-light: #333;
            --border-medium: #444;
            --border-dark: #555;

            background-image:
                radial-gradient(circle at 50% 50%, rgba(255, 255, 255, 0.01) 1px, transparent 1px),
                linear-gradient(to right, rgba(255, 255, 255, 0.01) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(255, 255, 255, 0.01) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html {
            font-size: var(--text-base);
            height: 100%;
            scroll-behavior: smooth;
        }

        body {
            font-family: var(--font-sans);
            line-height: 1.5;
            color: var(--text-primary);
            background-color: var(--bg-primary);
            min-height: 100vh;
            overflow-x: hidden;
            transition:
                background-color var(--transition-normal),
                color var(--transition-normal);
        }

        /* Typography Enhancements */
        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            font-weight: 600;
            line-height: 1.25;
            margin-bottom: var(--space-sm);
            color: var(--text-primary);
        }

        p {
            margin-bottom: var(--space-md);
            color: var(--text-secondary);
        }

        a {
            color: var(--primary);
            text-decoration: none;
            transition: color var(--transition-fast);
        }

        a:hover {
            color: var(--primary-dark);
        }

        /* Layout Components */
        .container {
            width: 100%;
            max-width: 1440px;
            margin: 0 auto;
            padding: 0 var(--space-md);
        }

        /* Sidebar - Premium Redesign */
        .sidebar {
            width: 280px;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            z-index: var(--z-index-fixed);
            display: flex;
            flex-direction: column;
            background-color: var(--bg-elevated);
            border-right: 1px solid var(--border-light);
            transform: translateX(-100%);
            opacity: 0;
            visibility: hidden;
            transition:
                transform var(--transition-normal),
                opacity var(--transition-normal),
                visibility 0s linear var(--transition-normal);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
        }

        .sidebar.active {
            transform: translateX(0);
            opacity: 1;
            visibility: visible;
            transition:
                transform var(--transition-normal),
                opacity var(--transition-normal),
                visibility 0s linear;
        }

        .sidebar-header {
            padding: var(--space-md);
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 60px;
            border-bottom: 1px solid var(--border-light);
            background-color: var(--bg-elevated);
        }

        .sidebar-title {
            font-size: var(--text-xl);
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            color: var(--primary);
        }

        .sidebar-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: var(--text-xl);
            cursor: pointer;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-full);
            transition:
                background-color var(--transition-fast),
                color var(--transition-fast);
        }

        .sidebar-close:hover {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-md) 0;
            scrollbar-width: thin;
            scrollbar-color: var(--primary) var(--bg-secondary);
        }

        .sidebar-content::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar-content::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        .sidebar-content::-webkit-scrollbar-thumb {
            background-color: var(--primary);
            border-radius: var(--radius-full);
        }

        .sidebar-section {
            margin-bottom: var(--space-lg);
        }

        .sidebar-section-title {
            padding: var(--space-xs) var(--space-md);
            font-size: var(--text-xs);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-tertiary);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .sidebar-item {
            padding: var(--space-sm) var(--space-md);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            cursor: pointer;
            transition:
                background-color var(--transition-fast),
                transform var(--transition-fast);
            border-radius: var(--radius-md);
            margin: 0 var(--space-sm);
            position: relative;
            overflow: hidden;
        }

        .sidebar-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background-color: var(--primary);
            transform: translateX(-100%);
            transition: transform var(--transition-normal);
        }

        .sidebar-item:hover {
            background-color: var(--bg-tertiary);
        }

        .sidebar-item:hover::before {
            transform: translateX(0);
        }

        .sidebar-item.active {
            background-color: var(--primary-light);
            color: var(--primary);
            font-weight: 500;
        }

        .sidebar-item.active::before {
            transform: translateX(0);
        }

        .sidebar-item-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: inherit;
            transition: color var(--transition-fast);
        }

        .sidebar-item:hover .sidebar-item-icon {
            color: var(--primary);
        }

        .sidebar-item-text {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-weight: 500;
        }

        .sidebar-item-count {
            background: var(--primary);
            color: var(--text-on-color);
            font-size: var(--text-xs);
            padding: 2px 6px;
            border-radius: var(--radius-full);
            min-width: 20px;
            text-align: center;
            font-weight: 600;
        }

        .sidebar-footer {
            padding: var(--space-md);
            border-top: 1px solid var(--border-light);
        }

        /* Workspace */
        .workspace {
            flex: 1;
            margin-left: 0;
            transition: margin-left var(--transition-normal);
        }

        .workspace.with-sidebar {
            margin-left: 280px;
        }

        /* Header - Premium Design */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 0 var(--space-md);
            height: 60px;
            background-color: var(--bg-elevated);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-light);
            z-index: var(--z-index-sticky);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition:
                background-color var(--transition-normal),
                border-color var(--transition-normal);
            box-shadow: var(--shadow-sm);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }

        .header-title {
            font-size: var(--text-lg);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .header-breadcrumb {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            font-size: var(--text-sm);
            color: var(--text-secondary);
        }

        .header-breadcrumb-separator {
            opacity: 0.5;
        }

        .header-actions {
            display: flex;
            gap: var(--space-sm);
        }

        /* Buttons - Premium Style */
        .btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            color: var(--text-primary);
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--radius-md);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-sm);
            font-weight: 500;
            transition:
                all var(--transition-fast),
                transform var(--transition-fast);
            font-size: var(--text-sm);
            font-family: var(--font-sans);
            position: relative;
            overflow: hidden;
        }

        .btn::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(rgba(255, 255, 255, 0.1), transparent);
            opacity: 0;
            transition: opacity var(--transition-fast);
        }

        .btn:hover::after {
            opacity: 1;
        }

        .btn:active {
            transform: scale(0.96);
        }

        .btn:hover {
            background-color: var(--bg-tertiary);
            box-shadow: var(--shadow-sm);
        }

        .btn-primary {
            background: var(--primary);
            color: var(--text-on-color);
            border: 1px solid var(--primary);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            border-color: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--secondary);
            color: var(--text-on-color);
            border: 1px solid var(--secondary);
        }

        .btn-secondary:hover {
            background: var(--secondary-dark);
            border-color: var(--secondary-dark);
        }

        .btn-danger {
            background: var(--danger);
            color: var(--text-on-color);
            border: 1px solid var(--danger);
        }

        .btn-danger:hover {
            background: var(--danger-dark);
            border-color: var(--danger-dark);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
        }

        .btn-outline:hover {
            background: var(--primary-light);
        }

        .btn-icon {
            width: 36px;
            height: 36px;
            padding: 0;
            border-radius: var(--radius-full);
        }

        .btn-sm {
            padding: var(--space-xs) var(--space-sm);
            font-size: var(--text-xs);
        }

        /* Notes Grid - Premium Layout */
        .notes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: var(--space-md);
            margin-top: calc(60px + var(--space-md));
            margin-bottom: 100px;
            padding: var(--space-md);
        }

        /* Note Card - Premium Design */
        .note-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            padding: var(--space-md);
            transition:
                all var(--transition-normal),
                transform var(--transition-fast);
            cursor: pointer;
            box-shadow: var(--shadow-sm);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            will-change: transform;
        }

        .note-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, transparent 100%);
            opacity: 0;
            transition: opacity var(--transition-normal);
        }

        .note-card:hover::before {
            opacity: 1;
        }

        .note-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
            border-color: var(--primary);
        }

        .note-card:active {
            transform: translateY(-2px) scale(0.98);
        }

        .note-card.pinned::after {
            content: '\f08d';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            top: var(--space-sm);
            right: var(--space-sm);
            color: var(--primary);
            font-size: 14px;
        }

        .note-card-tags {
            display: flex;
            gap: var(--space-xs);
            margin-bottom: var(--space-sm);
            flex-wrap: wrap;
        }

        .note-card-tag {
            background: var(--primary-light);
            color: var(--primary);
            font-size: var(--text-xs);
            padding: 2px 8px;
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            gap: 3px;
            font-weight: 500;
            transition:
                background-color var(--transition-fast),
                color var(--transition-fast);
        }

        .note-card-tag:hover {
            background: var(--primary);
            color: var(--text-on-color);
        }

        .note-card-title {
            font-size: var(--text-lg);
            font-weight: 600;
            margin-bottom: var(--space-sm);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--text-primary);
        }

        .note-card-content {
            color: var(--text-secondary);
            font-size: var(--text-sm);
            flex: 1;
            display: -webkit-box;
            -webkit-line-clamp: 5;
            -webkit-box-orient: vertical;
            overflow: hidden;
            margin-bottom: var(--space-md);
        }

        .note-card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: var(--text-xs);
            color: var(--text-tertiary);
        }

        .note-card-attachment {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }

        /* File Card - Premium Design */
        .file-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            padding: var(--space-md);
            transition:
                all var(--transition-normal),
                transform var(--transition-fast);
            cursor: pointer;
            box-shadow: var(--shadow-sm);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            will-change: transform;
            position: relative;
            overflow: hidden;
        }

        .file-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, transparent 100%);
            opacity: 0;
            transition: opacity var(--transition-normal);
        }

        .file-card:hover::before {
            opacity: 1;
        }

        .file-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
            border-color: var(--primary);
        }

        .file-card:active {
            transform: translateY(-2px) scale(0.98);
        }

        .file-card-icon {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: var(--space-sm);
            color: var(--primary);
            font-size: var(--text-2xl);
        }

        .file-card-name {
            font-weight: 500;
            margin-bottom: var(--space-xs);
            word-break: break-word;
            width: 100%;
            color: var(--text-primary);
        }

        .file-card-size {
            font-size: var(--text-xs);
            color: var(--text-tertiary);
        }

        /* Floating Action Button - Premium Design */
        .fab {
            position: fixed;
            bottom: var(--space-xl);
            right: var(--space-xl);
            width: 56px;
            height: 56px;
            border-radius: var(--radius-full);
            background: var(--primary);
            color: var(--text-on-color);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            transition:
                all var(--transition-normal),
                transform var(--transition-fast);
            z-index: var(--z-index-sticky);
            border: none;
            font-size: var(--text-xl);
            will-change: transform;
        }

        .fab::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, rgba(255, 255, 255, 0.3) 0%, transparent 70%);
            opacity: 0;
            transition: opacity var(--transition-normal);
        }

        .fab:hover::after {
            opacity: 1;
        }

        .fab:hover {
            transform: scale(1.1) translateY(-5px);
            box-shadow: 0 8px 30px rgba(67, 97, 238, 0.4);
        }

        .fab:active {
            transform: scale(0.95);
        }

        /* Note Editor - Premium Design */
        .editor-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            z-index: var(--z-index-modal);
            display: flex;
            flex-direction: column;
            transform: translateY(100%);
            transition:
                transform var(--transition-normal),
                opacity var(--transition-normal);
            opacity: 0;
            visibility: hidden;
            will-change: transform, opacity;
        }

        .editor-container.active {
            transform: translateY(0);
            opacity: 1;
            visibility: visible;
        }

        .editor-header {
            padding: var(--space-sm) var(--space-md);
            background: var(--bg-elevated);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }

        .editor-actions {
            display: flex;
            gap: var(--space-sm);
        }

        .editor-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .editor-title-container {
            padding: var(--space-md) var(--space-md) 0;
        }

        .editor-title {
            font-size: var(--text-3xl);
            font-weight: 700;
            border: none;
            background: transparent;
            color: var(--text-primary);
            width: 100%;
            padding: var(--space-sm);
            border-radius: var(--radius-sm);
            transition: background-color var(--transition-fast);
            font-family: var(--font-sans);
        }

        .editor-title:focus {
            outline: none;
            background: var(--bg-secondary);
        }

        .editor-tags {
            display: flex;
            gap: var(--space-xs);
            padding: 0 var(--space-md);
            margin-top: var(--space-sm);
            flex-wrap: wrap;
        }

        .editor-tag {
            background: var(--primary-light);
            color: var(--primary);
            font-size: var(--text-xs);
            padding: 4px 10px;
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            font-weight: 500;
            transition:
                background-color var(--transition-fast),
                color var(--transition-fast);
        }

        .editor-tag:hover {
            background: var(--primary);
            color: var(--text-on-color);
        }

        .editor-tag-remove {
            cursor: pointer;
            opacity: 0.7;
            transition: opacity var(--transition-fast);
            margin-left: var(--space-xs);
        }

        .editor-tag-remove:hover {
            opacity: 1;
        }

        .editor-tag-input {
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-size: var(--text-xs);
            padding: 4px 0;
            min-width: 80px;
            font-family: var(--font-sans);
        }

        .editor-tag-input:focus {
            outline: none;
        }

        .editor-body-container {
            flex: 1;
            padding: var(--space-md);
            overflow: hidden;
            display: flex;
        }

        .editor-body {
            flex: 1;
            border: none;
            background: transparent;
            color: var(--text-primary);
            resize: none;
            font-family: var(--font-sans);
            font-size: var(--text-base);
            line-height: 1.6;
            padding: var(--space-sm);
            border-radius: var(--radius-sm);
            transition: background-color var(--transition-fast);
            overflow-y: auto;
        }

        .editor-body:focus {
            outline: none;
            background: var(--bg-secondary);
        }

        .editor-footer {
            padding: var(--space-sm) var(--space-md);
            background: var(--bg-elevated);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-top: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .editor-info {
            font-size: var(--text-xs);
            color: var(--text-tertiary);
        }

        /* Rich Text Editor - Premium Style */
        .ql-container {
            font-family: var(--font-sans);
            font-size: var(--text-base);
            border: none !important;
            background: transparent;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .ql-editor {
            flex: 1;
            padding: var(--space-md) !important;
            color: var(--text-primary);
            line-height: 1.6;
        }

        .ql-toolbar {
            background: var(--bg-elevated) !important;
            backdrop-filter: blur(10px) !important;
            -webkit-backdrop-filter: blur(10px) !important;
            border: none !important;
            border-bottom: 1px solid var(--border-light) !important;
            padding: var(--space-sm) !important;
        }

        .ql-snow .ql-stroke {
            stroke: var(--text-primary);
        }

        .ql-snow .ql-fill {
            fill: var(--text-primary);
        }

        .ql-snow .ql-picker {
            color: var(--text-primary);
        }

        .ql-snow .ql-picker-options {
            background: var(--bg-elevated) !important;
            border: 1px solid var(--border-light) !important;
            border-radius: var(--radius-md) !important;
            box-shadow: var(--shadow-md) !important;
        }

        /* Search Bar - Premium Style */
        .search-container {
            margin: var(--space-md) 0;
            position: relative;
            padding: 0 var(--space-md);
        }

        .search-input {
            width: 100%;
            padding: var(--space-sm) var(--space-md);
            padding-left: 40px;
            border-radius: var(--radius-full);
            border: 1px solid var(--border-light);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: var(--text-base);
            transition:
                all var(--transition-fast),
                box-shadow var(--transition-fast);
            font-family: var(--font-sans);
        }

        .search-input:focus {
            outline: none;
            background: var(--bg-tertiary);
            box-shadow: 0 0 0 2px var(--primary-light);
            border-color: var(--primary);
        }

        .search-icon {
            position: absolute;
            left: 28px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-tertiary);
        }

        /* Empty State - Premium Design */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: var(--space-xl) var(--space-md);
            color: var(--text-tertiary);
            margin-top: 60px;
        }

        .empty-state-icon {
            font-size: var(--text-4xl);
            margin-bottom: var(--space-md);
            opacity: 0.3;
        }

        /* File Manager */
        .file-manager {
            display: flex;
            flex-direction: column;
            margin-top: calc(60px + var(--space-md));
            padding: var(--space-md);
        }

        .file-manager-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-md);
        }

        .file-manager-title {
            font-size: var(--text-2xl);
            font-weight: 600;
        }

        .file-manager-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: var(--space-md);
        }

        /* Folder View */
        .folder-view {
            margin-top: calc(60px + var(--space-md));
            padding: var(--space-md);
        }

        .folder-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-md);
        }

        .folder-title {
            font-size: var(--text-2xl);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .folder-breadcrumb {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            font-size: var(--text-sm);
            color: var(--text-secondary);
            margin-bottom: var(--space-sm);
            flex-wrap: wrap;
        }

        .folder-breadcrumb-item {
            cursor: pointer;
            transition: color var(--transition-fast);
        }

        .folder-breadcrumb-item:hover {
            color: var(--primary);
        }

        .folder-breadcrumb-separator {
            opacity: 0.5;
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .note-card,
        .file-card {
            animation: fadeIn 0.3s var(--transition-normal) forwards;
            opacity: 0;
        }

        .modal-content {
            animation: scaleIn 0.3s var(--transition-normal) forwards;
            opacity: 0;
            transform: scale(0.9);
        }

        /* Modal - Premium Design */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: var(--z-index-modal);
            opacity: 0;
            visibility: hidden;
            transition:
                opacity var(--transition-normal),
                visibility 0s linear var(--transition-normal);
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
            transition:
                opacity var(--transition-normal),
                visibility 0s linear;
        }

        .modal-content {
            background: var(--bg-elevated);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            padding: var(--space-lg);
            box-shadow: var(--shadow-xl);
            transform: translateY(20px);
            transition:
                transform var(--transition-normal),
                opacity var(--transition-normal);
        }

        .modal.active .modal-content {
            transform: translateY(0);
            opacity: 1;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-md);
        }

        .modal-title {
            font-size: var(--text-xl);
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: var(--text-xl);
            cursor: pointer;
            color: var(--text-secondary);
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-full);
            transition: background-color var(--transition-fast);
        }

        .modal-close:hover {
            background-color: var(--bg-tertiary);
        }

        .settings-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-md) 0;
            border-bottom: 1px solid var(--border-light);
        }

        .settings-option:last-child {
            border-bottom: none;
        }

        .settings-label {
            font-weight: 500;
        }

        .settings-description {
            font-size: var(--text-xs);
            color: var(--text-tertiary);
            margin-top: var(--space-xs);
        }

        /* Toggle Switch - Premium Design */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 30px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border-medium);
            transition: all var(--transition-normal);
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 2px;
            bottom: 2px;
            background-color: var(--white);
            transition: all var(--transition-normal);
            border-radius: 50%;
            box-shadow: var(--shadow-sm);
        }

        input:checked+.slider {
            background-color: var(--primary);
        }

        input:checked+.slider:before {
            transform: translateX(20px);
        }

        /* Password Modal - Premium Design */
        .password-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: var(--z-index-modal);
            opacity: 0;
            visibility: hidden;
            transition:
                opacity var(--transition-normal),
                visibility 0s linear var(--transition-normal);
        }

        .password-modal.active {
            opacity: 1;
            visibility: visible;
            transition:
                opacity var(--transition-normal),
                visibility 0s linear;
        }

        .password-modal-content {
            background: var(--bg-elevated);
            border-radius: var(--radius-md);
            padding: var(--space-lg);
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: var(--shadow-xl);
            transform: translateY(20px);
            transition:
                transform var(--transition-normal),
                opacity var(--transition-normal);
            opacity: 0;
        }

        .password-modal.active .password-modal-content {
            transform: translateY(0);
            opacity: 1;
        }

        .password-modal-title {
            font-size: var(--text-xl);
            margin-bottom: var(--space-md);
        }

        .password-modal-input {
            width: 100%;
            padding: var(--space-sm) var(--space-md);
            margin-bottom: var(--space-md);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-light);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: var(--text-base);
            font-family: var(--font-sans);
            transition: border-color var(--transition-fast);
        }

        .password-modal-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .password-modal-actions {
            display: flex;
            gap: var(--space-sm);
            justify-content: center;
        }

        /* Loading Animation - Premium Design */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            z-index: var(--z-index-modal);
            transition:
                opacity var(--transition-normal),
                visibility 0s linear var(--transition-normal);
        }

        .loading.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(67, 97, 238, 0.2);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s linear infinite;
            margin-bottom: var(--space-md);
        }

        .loading-text {
            color: var(--text-secondary);
            font-size: var(--text-sm);
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Context Menu - Premium Design */
        .context-menu {
            position: fixed;
            background: var(--bg-elevated);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-xl);
            z-index: var(--z-index-popover);
            display: none;
            min-width: 200px;
            overflow: hidden;
            transform-origin: top left;
            animation: scaleIn 0.2s var(--transition-normal) forwards;
            opacity: 0;
            transform: scale(0.9);
        }

        .context-menu.active {
            display: block;
        }

        .context-menu-item {
            padding: var(--space-sm) var(--space-md);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            transition: background-color var(--transition-fast);
        }

        .context-menu-item:hover {
            background-color: var(--bg-tertiary);
        }

        .context-menu-item-icon {
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
        }

        .context-menu-separator {
            height: 1px;
            background: var(--border-light);
            margin: var(--space-xs) 0;
        }

        /* Toast Notification - Premium Design */
        .toast {
            position: fixed;
            bottom: var(--space-xl);
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-elevated);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-full);
            padding: var(--space-sm) var(--space-md);
            box-shadow: var(--shadow-lg);
            z-index: var(--z-index-tooltip);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            opacity: 0;
            visibility: hidden;
            transition:
                all var(--transition-normal),
                transform var(--transition-normal);
            transform: translateX(-50%) translateY(20px);
            will-change: transform, opacity;
        }

        .toast.show {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
        }

        .toast.hide {
            opacity: 0;
            visibility: hidden;
            transform: translateX(-50%) translateY(20px);
        }

        .toast-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .toast-success {
            color: var(--success);
        }

        .toast-error {
            color: var(--danger);
        }

        /* Color picker for notes */
        .color-picker {
            display: flex;
            gap: var(--space-sm);
            padding: var(--space-sm);
            flex-wrap: wrap;
            background: var(--bg-elevated);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow-lg);
            position: absolute;
            right: var(--space-md);
            top: 50px;
            z-index: var(--z-index-dropdown);
        }

        .color-option {
            width: 24px;
            height: 24px;
            border-radius: var(--radius-full);
            cursor: pointer;
            border: 2px solid transparent;
            transition:
                transform var(--transition-fast),
                border-color var(--transition-fast);
            will-change: transform;
        }

        .color-option:hover {
            transform: scale(1.1);
        }

        .color-option.selected {
            border-color: var(--text-primary);
            transform: scale(1.1);
        }

        /* Note color classes */
        .note-color-default {
            background: var(--bg-elevated);
            border-color: var(--border-light);
        }

        .note-color-red {
            background: rgba(239, 35, 60, 0.1);
            border-color: rgba(239, 35, 60, 0.2);
        }

        .note-color-orange {
            background: rgba(248, 150, 30, 0.1);
            border-color: rgba(248, 150, 30, 0.2);
        }

        .note-color-yellow {
            background: rgba(255, 213, 0, 0.1);
            border-color: rgba(255, 213, 0, 0.2);
        }

        .note-color-green {
            background: rgba(0, 200, 83, 0.1);
            border-color: rgba(0, 200, 83, 0.2);
        }

        .note-color-teal {
            background: rgba(0, 150, 136, 0.1);
            border-color: rgba(0, 150, 136, 0.2);
        }

        .note-color-blue {
            background: rgba(67, 97, 238, 0.1);
            border-color: rgba(67, 97, 238, 0.2);
        }

        .note-color-indigo {
            background: rgba(48, 79, 254, 0.1);
            border-color: rgba(48, 79, 254, 0.2);
        }

        .note-color-purple {
            background: rgba(114, 9, 183, 0.1);
            border-color: rgba(114, 9, 183, 0.2);
        }

        .note-color-pink {
            background: rgba(248, 37, 133, 0.1);
            border-color: rgba(248, 37, 133, 0.2);
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .sidebar {
                width: 260px;
            }

            .workspace.with-sidebar {
                margin-left: 260px;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                max-width: 320px;
            }

            .workspace.with-sidebar {
                margin-left: 0;
            }

            .notes-grid,
            .file-manager-grid {
                grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            }

            .header-title span {
                display: none;
            }

            .header-breadcrumb {
                display: none;
            }

            .fab {
                bottom: var(--space-lg);
                right: var(--space-lg);
            }
        }

        @media (max-width: 480px) {

            .notes-grid,
            .file-manager-grid {
                grid-template-columns: 1fr;
            }

            .editor-title {
                font-size: var(--text-2xl);
            }

            .modal-content {
                padding: var(--space-md);
            }

            .fab {
                width: 48px;
                height: 48px;
                bottom: var(--space-md);
                right: var(--space-md);
                font-size: var(--text-lg);
            }
        }

        /* Physics-based animations for interactive elements */
        .btn,
        .btn-icon,
        .note-card,
        .file-card,
        .sidebar-item,
        .context-menu-item {
            transition:
                transform 0.1s cubic-bezier(0.175, 0.885, 0.32, 1.275),
                background-color var(--transition-fast),
                box-shadow var(--transition-fast);
            will-change: transform;
        }

        .btn:active,
        .btn-icon:active,
        .note-card:active,
        .file-card:active,
        .sidebar-item:active,
        .context-menu-item:active {
            transform: scale(0.96);
        }

        /* Micro-interactions for hover states */
        .btn:hover,
        .btn-icon:hover,
        .note-card:hover,
        .file-card:hover,
        .sidebar-item:hover,
        .context-menu-item:hover {
            transition:
                transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275),
                background-color var(--transition-fast),
                box-shadow var(--transition-fast);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }
    </style>
</head>

<body>
    <!-- Permission Request Modal -->
    <div class="permission-modal active" id="permission-modal">
        <div class="permission-modal-content">
            <div class="permission-icon">
                <i class="fas fa-shield-alt"></i>
            </div>
            <h3>Permission Required</h3>
            <p>NoteDecs needs your permission to securely store your notes and files locally in your browser.</p>
            <div class="permission-options">
                <div class="permission-item">
                    <i class="fas fa-file-alt"></i>
                    <span>Store notes securely</span>
                </div>
                <div class="permission-item">
                    <i class="fas fa-file-upload"></i>
                    <span>Upload files (optional)</span>
                </div>
            </div>
            <div class="permission-actions">
                <button class="btn" id="deny-permission-btn">Deny</button>
                <button class="btn btn-primary" id="grant-permission-btn">Grant Permission</button>
            </div>
            <div class="permission-footer">
                <i class="fas fa-lock"></i>
                <span>All data stays on your device. We never access your information.</span>
            </div>
        </div>
    </div>

    <div class="loading">
        <div class="loading-spinner"></div>
        <div class="loading-text">Initializing secure environment...</div>
    </div>

    <!-- Main App (initially hidden) -->
    <div class="app-container" id="app-container" style="display: none;">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title"><i class="fas fa-book-open"></i> NoteDecs</div>
                <button class="sidebar-close" id="sidebar-close-btn">&times;</button>
            </div>
            <div class="sidebar-content">
                <div class="sidebar-section">
                    <div class="sidebar-item active" data-view="notes">
                        <div class="sidebar-item-icon">
                            <i class="fas fa-sticky-note"></i>
                        </div>
                        <div class="sidebar-item-text">All Notes</div>
                        <div class="sidebar-item-count" id="all-notes-count">0</div>
                    </div>
                    <div class="sidebar-item" data-view="pinned">
                        <div class="sidebar-item-icon">
                            <i class="fas fa-thumbtack"></i>
                        </div>
                        <div class="sidebar-item-text">Pinned</div>
                        <div class="sidebar-item-count" id="pinned-notes-count">0</div>
                    </div>
                    <div class="sidebar-item" data-view="favorites">
                        <div class="sidebar-item-icon">
                            <i class="fas fa-star"></i>
                        </div>
                        <div class="sidebar-item-text">Favorites</div>
                        <div class="sidebar-item-count" id="favorite-notes-count">0</div>
                    </div>
                    <div class="sidebar-item" data-view="trash">
                        <div class="sidebar-item-icon">
                            <i class="fas fa-trash"></i>
                        </div>
                        <div class="sidebar-item-text">Trash</div>
                        <div class="sidebar-item-count" id="trash-notes-count">0</div>
                    </div>
                </div>

                <div class="sidebar-section">
                    <div class="sidebar-section-title">
                        <span>Tags</span>
                        <button class="btn-icon btn-sm" id="add-tag-btn">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div id="tags-list">
                        <!-- Tags will be dynamically inserted here -->
                    </div>
                </div>

                <div class="sidebar-section">
                    <div class="sidebar-section-title">Files</div>
                    <div class="sidebar-item" data-view="files">
                        <div class="sidebar-item-icon">
                            <i class="fas fa-folder"></i>
                        </div>
                        <div class="sidebar-item-text">All Files</div>
                    </div>
                    <div class="sidebar-item" data-view="recent-files">
                        <div class="sidebar-item-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="sidebar-item-text">Recent Files</div>
                    </div>
                </div>
            </div>
            <div class="sidebar-footer">
                <button class="btn btn-primary" id="lock-app-btn">
                    <i class="fas fa-lock"></i> Lock App
                </button>
            </div>
        </div>

        <!-- Workspace -->
        <div class="workspace" id="workspace">
            <!-- Header -->
            <header class="header">
                <div class="header-left">
                    <button class="btn btn-icon" id="sidebar-toggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="header-title">
                        <span id="current-view-title">All Notes</span>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="btn btn-icon" id="search-btn">
                        <i class="fas fa-search"></i>
                    </button>
                    <button class="btn btn-icon" id="settings-btn">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
            </header>

            <!-- Search Bar -->
            <div class="search-container" id="search-container" style="display: none;">
                <div class="search-icon">
                    <i class="fas fa-search"></i>
                </div>
                <input type="text" class="search-input" id="search-input" placeholder="Search notes...">
                <button class="btn btn-icon" id="close-search-btn">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Main Content -->
            <div class="container-content">
                <!-- Notes View -->
                <div class="notes-view" id="notes-view">
                    <div class="notes-grid" id="notes-grid">
                        <!-- Notes will be dynamically inserted here -->
                    </div>

                    <!-- Empty State -->
                    <div class="empty-state" id="empty-state" style="display: none;">
                        <div class="empty-state-icon">
                            <i class="fas fa-sticky-note"></i>
                        </div>
                        <h3>No Notes Found</h3>
                        <p>Create your first note by clicking the + button below</p>
                    </div>
                </div>

                <!-- Files View -->
                <div class="files-view" id="files-view" style="display: none;">
                    <div class="file-manager">
                        <div class="file-manager-header">
                            <div class="file-manager-title">All Files</div>
                            <button class="btn btn-primary" id="upload-file-btn">
                                <i class="fas fa-plus"></i>
                                Upload File
                            </button>
                            <input type="file" id="file-upload-input" multiple style="display: none;">
                        </div>
                        <div class="file-manager-grid" id="file-manager-grid">
                            <!-- Files will be dynamically inserted here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Floating Action Button -->
        <button class="fab" id="new-note-btn">
            <i class="fas fa-plus"></i>
        </button>

        <!-- Note Editor -->
        <div class="editor-container" id="editor-container">
            <div class="editor-header">
                <button class="btn" id="editor-back-btn">
                    <i class="fas fa-arrow-left"></i> Back
                </button>
                <div class="editor-actions">
                    <button class="btn btn-icon" id="color-picker-btn">
                        <i class="fas fa-palette"></i>
                    </button>
                    <div class="color-picker" id="color-picker" style="display: none;">
                        <div class="color-option selected" data-color="default"></div>
                        <div class="color-option" data-color="red"></div>
                        <div class="color-option" data-color="orange"></div>
                        <div class="color-option" data-color="yellow"></div>
                        <div class="color-option" data-color="green"></div>
                        <div class="color-option" data-color="teal"></div>
                        <div class="color-option" data-color="blue"></div>
                        <div class="color-option" data-color="indigo"></div>
                        <div class="color-option" data-color="purple"></div>
                        <div class="color-option" data-color="pink"></div>
                    </div>
                    <button class="btn btn-icon" id="emoji-picker-btn">
                        <i class="far fa-smile"></i>
                    </button>
                    <div class="emoji-picker" id="emoji-picker">
                        <!-- Emojis will be dynamically inserted here -->
                    </div>
                    <button class="btn btn-icon" id="pin-note-btn">
                        <i class="far fa-thumbtack"></i>
                    </button>
                    <button class="btn btn-icon" id="favorite-note-btn">
                        <i class="far fa-star"></i>
                    </button>
                    <button class="btn btn-icon" id="attach-file-btn">
                        <i class="fas fa-paperclip"></i>
                    </button>
                    <button class="btn btn-icon" id="duplicate-note-btn">
                        <i class="far fa-copy"></i>
                    </button>
                    <button class="btn btn-icon" id="delete-note-btn">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <div class="editor-content">
                <div class="editor-title-container">
                    <input type="text" class="editor-title" id="editor-title" placeholder="Note Title" maxlength="200">
                </div>
                <div class="editor-tags" id="editor-tags">
                    <!-- Tags will be dynamically inserted here -->
                    <input type="text" class="editor-tag-input" id="editor-tag-input" placeholder="Add tag..." maxlength="20">
                </div>
                <div class="editor-body-container">
                    <div class="editor-body" id="editor-body"></div>
                </div>
            </div>
            <div class="editor-footer">
                <div class="editor-info">
                    <span id="editor-updated-at">Just now</span>
                    <span id="editor-word-count">0 words</span>
                </div>
                <div class="editor-actions">
                    <button class="btn btn-sm" id="markdown-toggle-btn">Markdown Mode</button>
                </div>
            </div>
        </div>

        <!-- Settings Modal -->
        <div class="modal" id="settings-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Security & Settings</h3>
                    <button class="modal-close" id="settings-close-btn">&times;</button>
                </div>

                <div class="settings-option">
                    <div>
                        <span class="settings-label">App Theme</span>
                        <div class="settings-description">Choose your preferred color scheme</div>
                    </div>
                    <select id="theme-selector" class="btn btn-sm">
                        <option value="light">Light</option>
                        <option value="dark">Dark</option>
                        <option value="black">Pure Black</option>
                    </select>
                </div>

                <div class="settings-option">
                    <div>
                        <span class="settings-label">Password Protection</span>
                        <div class="settings-description">Require password to access the app</div>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="lock-toggle">
                        <span class="slider"></span>
                    </label>
                </div>

                <div class="settings-option" id="password-input-container" style="display: none;">
                    <div>
                        <span class="settings-label">Set Password</span>
                        <div class="settings-description">Enter a strong password (min 8 characters)</div>
                    </div>
                    <input type="password" id="password-input" class="btn" placeholder="Enter password" minlength="8">
                </div>

                <div class="settings-option">
                    <div>
                        <span class="settings-label">End-to-End Encryption</span>
                        <div class="settings-description">Encrypt your notes with AES-256</div>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="encryption-toggle">
                        <span class="slider"></span>
                    </label>
                </div>

                <div class="settings-option" id="encryption-key-container" style="display: none;">
                    <div>
                        <span class="settings-label">Encryption Key</span>
                        <div class="settings-description">Save this key to decrypt your notes</div>
                    </div>
                    <div class="btn" id="encryption-key" style="word-break: break-all; text-align: left; cursor: pointer;"></div>
                </div>

                <div class="settings-option">
                    <div class="accessibility-option">
                        <span class="settings-label">Font Size</span>
                        <div class="font-size-control">
                            <button class="font-size-btn" id="font-decrease-btn"><i class="fas fa-minus"></i></button>
                            <span class="font-size-value" id="font-size-value">16px</span>
                            <button class="font-size-btn" id="font-increase-btn"><i class="fas fa-plus"></i></button>
                        </div>
                    </div>
                </div>

                <div class="settings-option">
                    <div>
                        <span class="settings-label">Clean Paste</span>
                        <div class="settings-description">Remove formatting when pasting text</div>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="clean-paste-toggle">
                        <span class="slider"></span>
                    </label>
                </div>

                <div class="settings-option">
                    <div>
                        <span class="settings-label">Auto-Save Interval</span>
                        <div class="settings-description">How often to save changes (seconds)</div>
                    </div>
                    <select id="autosave-interval" class="btn btn-sm">
                        <option value="1">1</option>
                        <option value="3" selected>3</option>
                        <option value="5">5</option>
                        <option value="10">10</option>
                    </select>
                </div>

                <div class="settings-option">
                    <button class="btn btn-danger" id="reset-app-btn">
                        <i class="fas fa-trash"></i> Reset All Data
                    </button>
                </div>
            </div>
        </div>

        <!-- Password Modal -->
        <div class="password-modal" id="password-modal">
            <div class="password-modal-content">
                <div class="password-modal-icon">
                    <i class="fas fa-lock"></i>
                </div>
                <h3 class="password-modal-title">Enter Password</h3>
                <input type="password" class="password-modal-input" id="password-modal-input" placeholder="Enter your password">
                <div class="password-modal-actions">
                    <button class="btn" id="password-cancel-btn">Cancel</button>
                    <button class="btn btn-primary" id="password-submit-btn">Unlock</button>
                </div>
            </div>
        </div>

        <!-- Confirmation Modal -->
        <div class="confirmation-modal" id="confirmation-modal">
            <div class="confirmation-modal-content">
                <div class="confirmation-modal-icon" id="confirmation-modal-icon">
                    <i class="fas fa-question-circle"></i>
                </div>
                <h3 class="confirmation-modal-title" id="confirmation-modal-title">Confirm Action</h3>
                <p class="confirmation-modal-message" id="confirmation-modal-message">Are you sure you want to perform this action?</p>
                <div class="confirmation-modal-actions">
                    <button class="btn" id="confirmation-cancel-btn">Cancel</button>
                    <button class="btn btn-primary" id="confirmation-confirm-btn">Confirm</button>
                </div>
            </div>
        </div>

        <!-- File Preview Modal -->
        <div class="file-preview-modal" id="file-preview-modal">
            <div class="file-preview-content">
                <div class="file-preview-header">
                    <h3 class="file-preview-title" id="file-preview-title"></h3>
                    <button class="file-preview-close" id="file-preview-close">&times;</button>
                </div>
                <div class="file-preview-body" id="file-preview-body">
                    <div class="file-preview-loading">
                        <div class="spinner"></div>
                        <p>Loading preview...</p>
                    </div>
                </div>
                <div class="file-preview-footer">
                    <button class="btn" id="file-preview-download">
                        <i class="fas fa-download"></i> Download
                    </button>
                </div>
            </div>
        </div>

        <!-- Toast Notification -->
        <div class="toast" id="toast">
            <div class="toast-icon" id="toast-icon">
                <i class="fas fa-info-circle"></i>
            </div>
            <div class="toast-message" id="toast-message">Notification message</div>
        </div>
    </div>

    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script>
        // Constants
        const FILE_SIZE_LIMIT = 10 * 1024 * 1024; // 10MB
        const ALLOWED_FILE_TYPES = [
            'image/jpeg', 'image/png', 'image/gif', 'image/webp',
            'application/pdf',
            'text/plain', 'text/markdown', 'text/csv',
            'application/json',
            'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
            'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
            'application/vnd.openxmlformats-officedocument.presentationml.presentation'
        ];

        // DOM Elements
        const permissionModal = document.getElementById('permission-modal');
        const grantPermissionBtn = document.getElementById('grant-permission-btn');
        const denyPermissionBtn = document.getElementById('deny-permission-btn');
        const appContainer = document.getElementById('app-container');
        const loadingScreen = document.querySelector('.loading');
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const sidebarCloseBtn = document.getElementById('sidebar-close-btn');
        const workspace = document.getElementById('workspace');
        const currentViewTitle = document.getElementById('current-view-title');
        const notesView = document.getElementById('notes-view');
        const filesView = document.getElementById('files-view');
        const notesGrid = document.getElementById('notes-grid');
        const fileManagerGrid = document.getElementById('file-manager-grid');
        const emptyState = document.getElementById('empty-state');
        const newNoteBtn = document.getElementById('new-note-btn');
        const editorContainer = document.getElementById('editor-container');
        const editorTitle = document.getElementById('editor-title');
        const editorBody = document.getElementById('editor-body');
        const editorTags = document.getElementById('editor-tags');
        const editorTagInput = document.getElementById('editor-tag-input');
        const editorBackBtn = document.getElementById('editor-back-btn');
        const colorPickerBtn = document.getElementById('color-picker-btn');
        const colorPicker = document.getElementById('color-picker');
        const emojiPickerBtn = document.getElementById('emoji-picker-btn');
        const emojiPicker = document.getElementById('emoji-picker');
        const pinNoteBtn = document.getElementById('pin-note-btn');
        const favoriteNoteBtn = document.getElementById('favorite-note-btn');
        const attachFileBtn = document.getElementById('attach-file-btn');
        const duplicateNoteBtn = document.getElementById('duplicate-note-btn');
        const deleteNoteBtn = document.getElementById('delete-note-btn');
        const markdownToggleBtn = document.getElementById('markdown-toggle-btn');
        const editorUpdatedAt = document.getElementById('editor-updated-at');
        const editorWordCount = document.getElementById('editor-word-count');
        const searchBtn = document.getElementById('search-btn');
        const closeSearchBtn = document.getElementById('close-search-btn');
        const searchContainer = document.getElementById('search-container');
        const searchInput = document.getElementById('search-input');
        const settingsBtn = document.getElementById('settings-btn');
        const settingsModal = document.getElementById('settings-modal');
        const settingsCloseBtn = document.getElementById('settings-close-btn');
        const themeSelector = document.getElementById('theme-selector');
        const lockToggle = document.getElementById('lock-toggle');
        const passwordInputContainer = document.getElementById('password-input-container');
        const passwordInput = document.getElementById('password-input');
        const encryptionToggle = document.getElementById('encryption-toggle');
        const encryptionKeyContainer = document.getElementById('encryption-key-container');
        const encryptionKey = document.getElementById('encryption-key');
        const cleanPasteToggle = document.getElementById('clean-paste-toggle');
        const autosaveInterval = document.getElementById('autosave-interval');
        const fontDecreaseBtn = document.getElementById('font-decrease-btn');
        const fontIncreaseBtn = document.getElementById('font-increase-btn');
        const fontSizeValue = document.getElementById('font-size-value');
        const resetAppBtn = document.getElementById('reset-app-btn');
        const passwordModal = document.getElementById('password-modal');
        const passwordModalInput = document.getElementById('password-modal-input');
        const passwordCancelBtn = document.getElementById('password-cancel-btn');
        const passwordSubmitBtn = document.getElementById('password-submit-btn');
        const lockAppBtn = document.getElementById('lock-app-btn');
        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmationIcon = document.getElementById('confirmation-modal-icon');
        const confirmationTitle = document.getElementById('confirmation-modal-title');
        const confirmationMessage = document.getElementById('confirmation-modal-message');
        const confirmationCancelBtn = document.getElementById('confirmation-cancel-btn');
        const confirmationConfirmBtn = document.getElementById('confirmation-confirm-btn');
        const filePreviewModal = document.getElementById('file-preview-modal');
        const filePreviewTitle = document.getElementById('file-preview-title');
        const filePreviewBody = document.getElementById('file-preview-body');
        const filePreviewClose = document.getElementById('file-preview-close');
        const filePreviewDownload = document.getElementById('file-preview-download');
        const toast = document.getElementById('toast');
        const toastIcon = document.getElementById('toast-icon');
        const toastMessage = document.getElementById('toast-message');
        const addTagBtn = document.getElementById('add-tag-btn');
        const tagsList = document.getElementById('tags-list');
        const allNotesCount = document.getElementById('all-notes-count');
        const pinnedNotesCount = document.getElementById('pinned-notes-count');
        const favoriteNotesCount = document.getElementById('favorite-notes-count');
        const trashNotesCount = document.getElementById('trash-notes-count');
        const uploadFileBtn = document.getElementById('upload-file-btn');
        const fileUploadInput = document.getElementById('file-upload-input');

        // App State
        let notes = [];
        let files = [];
        let tags = [];
        let currentNoteId = null;
        let currentFileId = null;
        let currentView = 'notes';
        let isLocked = false;
        let quill = null;
        let isMarkdownMode = false;
        let currentNoteColor = 'default';
        let autoSaveTimer = null;
        let currentConfirmation = null;
        let currentPreviewFileId = null;
        let hasStorageAccess = false;

        // Initialize the app
        function init() {
            // Show permission modal first
            permissionModal.classList.add('active');

            // Setup event listeners
            setupEventListeners();

            // Check if we have existing data
            checkExistingData();
        }

        // Check for existing data after permissions are granted
        function checkExistingData() {
            if (!hasStorageAccess) return;

            try {
                const savedNotes = localStorage.getItem('notedecs-notes');
                const savedFiles = localStorage.getItem('notedecs-files');
                const savedTags = localStorage.getItem('notedecs-tags');
                const savedSettings = localStorage.getItem('notedecs-settings');

                if (savedNotes) {
                    notes = JSON.parse(savedNotes);
                }

                if (savedFiles) {
                    files = JSON.parse(savedFiles);
                }

                if (savedTags) {
                    tags = JSON.parse(savedTags);
                }

                if (savedSettings) {
                    const settings = JSON.parse(savedSettings);
                    applySettings(settings);
                }

                updateCounts();
                renderNotes();
                renderTags();

                // Hide loading screen after a brief delay
                setTimeout(() => {
                    loadingScreen.classList.add('hidden');
                    appContainer.style.display = 'block';
                }, 500);
            } catch (e) {
                showToast('Error loading saved data', 'error');
                console.error('Error loading data:', e);
            }
        }

        // Apply saved settings
        function applySettings(settings) {
            if (settings.theme) {
                themeSelector.value = settings.theme;
            }

            if (settings.lockEnabled) {
                lockToggle.checked = settings.lockEnabled;
                passwordInputContainer.style.display = 'flex';

                if (settings.password) {
                    passwordInput.value = settings.password;

                    // If app was locked when closed, show lock screen
                    if (settings.isLocked) {
                        isLocked = true;
                        showPasswordModal();
                    }
                }
            }

            if (settings.encryptionEnabled) {
                encryptionToggle.checked = settings.encryptionEnabled;
                encryptionKeyContainer.style.display = 'flex';

                if (settings.encryptionKey) {
                    encryptionKey.textContent = settings.encryptionKey;
                }
            }

            if (settings.cleanPaste) {
                cleanPasteToggle.checked = settings.cleanPaste;
            }

            if (settings.fontSize) {
                document.body.style.fontSize = settings.fontSize;
                fontSizeValue.textContent = settings.fontSize;
            }

            if (settings.autosaveInterval) {
                autosaveInterval.value = settings.autosaveInterval;
            }

            updateTheme();
        }

        // Save data to localStorage
        function saveData() {
            if (!hasStorageAccess) return;

            try {
                // Encrypt notes if encryption is enabled
                let notesToSave = notes;
                if (encryptionToggle.checked && encryptionKey.textContent) {
                    notesToSave = encryptNotes(notes, encryptionKey.textContent);
                }

                localStorage.setItem('notedecs-notes', JSON.stringify(notesToSave));
                localStorage.setItem('notedecs-files', JSON.stringify(files));
                localStorage.setItem('notedecs-tags', JSON.stringify(tags));

                const settings = {
                    theme: themeSelector.value,
                    lockEnabled: lockToggle.checked,
                    password: passwordInput.value,
                    encryptionEnabled: encryptionToggle.checked,
                    encryptionKey: encryptionKey.textContent,
                    cleanPaste: cleanPasteToggle.checked,
                    fontSize: document.body.style.fontSize || '16px',
                    autosaveInterval: autosaveInterval.value,
                    isLocked: isLocked
                };

                localStorage.setItem('notedecs-settings', JSON.stringify(settings));
            } catch (e) {
                console.error('Error saving data:', e);
                showToast('Error saving data', 'error');
            }
        }

        // Encrypt notes
        function encryptNotes(notesToEncrypt, key) {
            return notesToEncrypt.map(note => {
                try {
                    const encryptedNote = {
                        ...note
                    };
                    if (encryptedNote.title) {
                        encryptedNote.title = CryptoJS.AES.encrypt(encryptedNote.title, key).toString();
                    }
                    if (encryptedNote.content) {
                        encryptedNote.content = CryptoJS.AES.encrypt(encryptedNote.content, key).toString();
                    }
                    return encryptedNote;
                } catch (e) {
                    console.error('Error encrypting note:', e);
                    return note;
                }
            });
        }

        // Decrypt notes
        function decryptNotes(notesToDecrypt, key) {
            return notesToDecrypt.map(note => {
                try {
                    const decryptedNote = {
                        ...note
                    };
                    if (decryptedNote.title) {
                        decryptedNote.title = CryptoJS.AES.decrypt(decryptedNote.title, key).toString(CryptoJS.enc.Utf8);
                    }
                    if (decryptedNote.content) {
                        decryptedNote.content = CryptoJS.AES.decrypt(decryptedNote.content, key).toString(CryptoJS.enc.Utf8);
                    }
                    return decryptedNote;
                } catch (e) {
                    console.error('Error decrypting note:', e);
                    return note;
                }
            });
        }

        // Initialize Quill editor
        function initQuill() {
            quill = new Quill('#editor-body', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        [{
                            'header': [1, 2, 3, false]
                        }],
                        ['bold', 'italic', 'underline', 'strike'],
                        [{
                            'color': []
                        }, {
                            'background': []
                        }],
                        [{
                            'list': 'ordered'
                        }, {
                            'list': 'bullet'
                        }],
                        ['link', 'image'],
                        ['clean']
                    ]
                },
                placeholder: 'Start writing...'
            });

            quill.on('text-change', () => {
                updateWordCount();
                debounceSave();
            });

            // Clean paste functionality
            if (cleanPasteToggle.checked) {
                enableCleanPaste();
            }
        }

        // Enable clean paste
        function enableCleanPaste() {
            quill.clipboard.addMatcher(Node.ELEMENT_NODE, (node, delta) => {
                const plaintext = delta.ops.map(op => op.insert).join('');
                return new Delta().insert(plaintext);
            });
        }

        // Disable clean paste
        function disableCleanPaste() {
            quill.clipboard.dangerouslyPasteHTML = quill.clipboard.convert;
        }

        // Update word count
        function updateWordCount() {
            const text = quill.getText().trim();
            const wordCount = text ? text.split(/\s+/).length : 0;
            editorWordCount.textContent = `${wordCount} words`;
        }

        // Render notes to the grid
        function renderNotes(filter = '') {
            notesGrid.innerHTML = '';

            let filteredNotes = getFilteredNotes(filter);

            if (filteredNotes.length === 0) {
                emptyState.style.display = 'flex';
                return;
            }

            emptyState.style.display = 'none';

            // Separate pinned and unpinned notes (except in pinned view)
            let pinnedNotes = [];
            let unpinnedNotes = [];

            if (currentView !== 'pinned') {
                pinnedNotes = filteredNotes.filter(note => note.pinned);
                unpinnedNotes = filteredNotes.filter(note => !note.pinned);
            } else {
                unpinnedNotes = filteredNotes;
            }

            // Sort by date (newest first)
            pinnedNotes.sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
            unpinnedNotes.sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));

            // Combine with pinned notes first
            const sortedNotes = [...pinnedNotes, ...unpinnedNotes];

            // Add a slight delay for staggered animations
            sortedNotes.forEach((note, index) => {
                setTimeout(() => {
                    const noteElement = createNoteElement(note);
                    notesGrid.appendChild(noteElement);
                }, index * 50);
            });
        }

        // Get filtered notes based on current view
        function getFilteredNotes(filter = '') {
            let filteredNotes = [];

            switch (currentView) {
                case 'notes':
                    filteredNotes = notes.filter(note => !note.trashed);
                    break;
                case 'pinned':
                    filteredNotes = notes.filter(note => note.pinned && !note.trashed);
                    break;
                case 'favorites':
                    filteredNotes = notes.filter(note => note.favorite && !note.trashed);
                    break;
                case 'trash':
                    filteredNotes = notes.filter(note => note.trashed);
                    break;
                default:
                    if (currentView.startsWith('tag:')) {
                        const tagName = currentView.replace('tag:', '');
                        filteredNotes = notes.filter(note =>
                            !note.trashed && note.tags && note.tags.includes(tagName));
                    } else {
                        filteredNotes = notes.filter(note => !note.trashed);
                    }
            }

            if (filter) {
                filteredNotes = filteredNotes.filter(note =>
                    (note.title && note.title.toLowerCase().includes(filter.toLowerCase())) ||
                    (note.content && note.content.toLowerCase().includes(filter.toLowerCase())) ||
                    (note.tags && note.tags.some(tag => tag.toLowerCase().includes(filter.toLowerCase())))
                );
            }

            return filteredNotes;
        }

        // Create a note card element
        function createNoteElement(note) {
            const noteElement = document.createElement('div');
            noteElement.className = `note-card ${note.pinned ? 'pinned' : ''} note-color-${note.color || 'default'}`;

            // Format content preview (strip HTML tags if any)
            let contentPreview = note.content || '';
            if (contentPreview) {
                contentPreview = contentPreview.replace(/<[^>]*>/g, '');
                if (contentPreview.length > 200) {
                    contentPreview = contentPreview.substring(0, 200) + '...';
                }
            }

            noteElement.innerHTML = `
                ${note.tags && note.tags.length > 0 ? `
                    <div class="note-card-tags">
                        ${note.tags.slice(0, 3).map(tag => `
                            <div class="note-card-tag">${tag}</div>
                        `).join('')}
                        ${note.tags.length > 3 ? `<div class="note-card-tag">+${note.tags.length - 3}</div>` : ''}
                    </div>
                ` : ''}
                <div class="note-card-title">${note.title || 'Untitled Note'}</div>
                <div class="note-card-content">${contentPreview || 'No content'}</div>
                <div class="note-card-footer">
                    <span>${formatDate(note.updatedAt)}</span>
                    ${note.attachments && note.attachments.length > 0 ? `
                        <div class="note-card-attachment">
                            <i class="fas fa-paperclip"></i>
                            <span>${note.attachments.length}</span>
                        </div>
                    ` : ''}
                </div>
            `;

            noteElement.addEventListener('click', () => openNoteEditor(note.id));
            return noteElement;
        }

        // Render files to the grid
        function renderFiles() {
            fileManagerGrid.innerHTML = '';

            if (files.length === 0) {
                emptyState.style.display = 'flex';
                emptyState.querySelector('h3').textContent = 'No Files Found';
                emptyState.querySelector('p').textContent = 'Upload your first file by clicking the upload button';
                return;
            }

            emptyState.style.display = 'none';

            files.forEach((file, index) => {
                setTimeout(() => {
                    const fileElement = createFileElement(file);
                    fileManagerGrid.appendChild(fileElement);
                }, index * 50);
            });
        }

        // Create a file card element
        function createFileElement(file) {
            const fileElement = document.createElement('div');
            fileElement.className = 'file-card';

            // Get file icon based on type
            const fileIcon = getFileIcon(file.type);

            fileElement.innerHTML = `
                <div class="file-card-icon">
                    ${fileIcon}
                </div>
                <div class="file-card-name">${file.name}</div>
                <div class="file-card-size">${formatFileSize(file.size)}</div>
                <div class="file-card-date">${formatDate(file.updatedAt)}</div>
            `;

            fileElement.addEventListener('click', () => previewFile(file.id));
            fileElement.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                showContextMenu(e, file.id, 'file');
            });

            return fileElement;
        }

        // Preview a file
        function previewFile(fileId) {
            const file = files.find(f => f.id === fileId);
            if (!file) return;

            currentPreviewFileId = fileId;
            filePreviewTitle.textContent = file.name;
            filePreviewBody.innerHTML = `
                <div class="file-preview-loading">
                    <div class="spinner"></div>
                    <p>Loading preview...</p>
                </div>
            `;
            filePreviewModal.classList.add('active');

            // Handle different file types
            if (file.type.startsWith('image/')) {
                previewImageFile(file);
            } else if (file.type === 'application/pdf') {
                previewPdfFile(file);
            } else if (file.type.startsWith('text/')) {
                previewTextFile(file);
            } else {
                filePreviewBody.innerHTML = `
                    <div class="file-preview-unsupported">
                        <i class="fas fa-file"></i>
                        <p>Preview not available for this file type</p>
                    </div>
                `;
            }
        }

        // Preview image file
        function previewImageFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                filePreviewBody.innerHTML = `
                    <div class="file-preview-image">
                        <img src="${e.target.result}" alt="${file.name}">
                    </div>
                `;
            };
            reader.readAsDataURL(new Blob([file.data]));
        }

        // Preview PDF file
        function previewPdfFile(file) {
            // Using PDF.js for PDF preview
            if (typeof pdfjsLib === 'undefined') {
                // Load PDF.js library dynamically
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js';
                script.onload = () => {
                    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js';
                    renderPdf(file);
                };
                document.head.appendChild(script);
            } else {
                renderPdf(file);
            }
        }

        // Render PDF preview
        function renderPdf(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const typedArray = new Uint8Array(e.target.result);
                pdfjsLib.getDocument(typedArray).promise.then(pdf => {
                    // Get the first page
                    pdf.getPage(1).then(page => {
                        const viewport = page.getViewport({
                            scale: 1.0
                        });
                        const canvas = document.createElement('canvas');
                        const context = canvas.getContext('2d');
                        canvas.height = viewport.height;
                        canvas.width = viewport.width;

                        filePreviewBody.innerHTML = '';
                        filePreviewBody.appendChild(canvas);

                        page.render({
                            canvasContext: context,
                            viewport: viewport
                        });
                    });
                }).catch(err => {
                    filePreviewBody.innerHTML = `
                        <div class="file-preview-error">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>Could not load PDF preview</p>
                        </div>
                    `;
                });
            };
            reader.readAsArrayBuffer(new Blob([file.data]));
        }

        // Preview text file
        function previewTextFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                filePreviewBody.innerHTML = `
                    <div class="file-preview-text">
                        <pre>${escapeHtml(e.target.result)}</pre>
                    </div>
                `;
            };
            reader.readAsText(new Blob([file.data]));
        }

        // Escape HTML for text preview
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Get appropriate icon for file type
        function getFileIcon(fileType) {
            const type = fileType ? fileType.split('/')[0] : 'default';
            const extension = fileType ? fileType.split('/')[1] : '';

            const icons = {
                image: `<i class="fas fa-image"></i>`,
                audio: `<i class="fas fa-music"></i>`,
                video: `<i class="fas fa-video"></i>`,
                'application/pdf': `<i class="fas fa-file-pdf"></i>`,
                'application/msword': `<i class="fas fa-file-word"></i>`,
                'application/vnd.openxmlformats-officedocument.wordprocessingml.document': `<i class="fas fa-file-word"></i>`,
                'application/vnd.ms-excel': `<i class="fas fa-file-excel"></i>`,
                'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': `<i class="fas fa-file-excel"></i>`,
                'application/vnd.ms-powerpoint': `<i class="fas fa-file-powerpoint"></i>`,
                'application/vnd.openxmlformats-officedocument.presentationml.presentation': `<i class="fas fa-file-powerpoint"></i>`,
                'application/zip': `<i class="fas fa-file-archive"></i>`,
                'text/plain': `<i class="fas fa-file-alt"></i>`,
                'text/markdown': `<i class="fas fa-file-code"></i>`,
                'text/html': `<i class="fas fa-file-code"></i>`,
                'application/json': `<i class="fas fa-file-code"></i>`,
                default: `<i class="fas fa-file"></i>`
            };

            if (icons[fileType]) return icons[fileType];
            if (icons[type]) return icons[type];
            return icons.default;
        }

        // Render tags to the sidebar
        function renderTags() {
            tagsList.innerHTML = '';

            if (tags.length === 0) {
                const emptyTag = document.createElement('div');
                emptyTag.className = 'sidebar-item';
                emptyTag.textContent = 'No tags yet';
                tagsList.appendChild(emptyTag);
                return;
            }

            tags.forEach(tag => {
                const tagElement = document.createElement('div');
                tagElement.className = 'sidebar-item';
                tagElement.dataset.view = `tag:${tag.name}`;

                tagElement.innerHTML = `
                    <div class="sidebar-item-icon">
                        <i class="fas fa-tag"></i>
                    </div>
                    <div class="sidebar-item-text">${tag.name}</div>
                    <div class="sidebar-item-count">${tag.count}</div>
                `;

                tagElement.addEventListener('click', () => {
                    currentView = `tag:${tag.name}`;
                    updateView();
                });

                tagsList.appendChild(tagElement);
            });
        }

        // Format date for display
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const now = new Date();
            const diffInDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));

            if (diffInDays === 0) {
                return date.toLocaleTimeString('en-US', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } else if (diffInDays < 7) {
                return date.toLocaleDateString('en-US', {
                    weekday: 'short'
                });
            } else if (date.getFullYear() === now.getFullYear()) {
                return date.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric'
                });
            } else {
                return date.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric'
                });
            }
        }

        // Format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Open note editor
        function openNoteEditor(noteId = null) {
            if (isLocked) {
                showToast('App is locked. Unlock to access notes.', 'error');
                return;
            }

            currentNoteId = noteId;

            if (noteId) {
                const note = notes.find(n => n.id === noteId);
                if (note) {
                    editorTitle.value = note.title || '';
                    try {
                        quill.setContents(JSON.parse(note.content));
                    } catch (e) {
                        quill.setContents([{
                            insert: note.content || '\n'
                        }]);
                    }
                    editorUpdatedAt.textContent = `Updated ${formatDate(note.updatedAt)}`;
                    updateWordCount();

                    // Set note color
                    currentNoteColor = note.color || 'default';
                    editorContainer.className = `editor-container ${currentNoteColor !== 'default' ? 'note-color-' + currentNoteColor : ''}`;

                    // Render tags
                    renderEditorTags(note.tags || []);

                    // Update button states
                    pinNoteBtn.classList.toggle('active', note.pinned);
                    pinNoteBtn.innerHTML = note.pinned ? '<i class="fas fa-thumbtack"></i>' : '<i class="far fa-thumbtack"></i>';
                    favoriteNoteBtn.classList.toggle('active', note.favorite);
                    favoriteNoteBtn.innerHTML = note.favorite ? '<i class="fas fa-star"></i>' : '<i class="far fa-star"></i>';
                }
            } else {
                // New note
                editorTitle.value = '';
                quill.setContents([{
                    insert: '\n'
                }]);
                editorUpdatedAt.textContent = 'Just now';
                editorWordCount.textContent = '0 words';
                renderEditorTags([]);
                currentNoteColor = 'default';
                editorContainer.className = 'editor-container';

                // Reset button states
                pinNoteBtn.classList.remove('active');
                pinNoteBtn.innerHTML = '<i class="far fa-thumbtack"></i>';
                favoriteNoteBtn.classList.remove('active');
                favoriteNoteBtn.innerHTML = '<i class="far fa-star"></i>';
                currentNoteId = generateId();
            }

            editorContainer.classList.add('active');
            editorTitle.focus();
        }

        // Render tags in editor
        function renderEditorTags(tagList) {
            editorTags.innerHTML = '';

            tagList.forEach(tag => {
                const tagElement = document.createElement('div');
                tagElement.className = 'editor-tag';
                tagElement.innerHTML = `
                    ${tag}
                    <span class="editor-tag-remove">&times;</span>
                `;
                tagElement.querySelector('.editor-tag-remove').addEventListener('click', () => {
                    removeTagFromNote(tag, currentNoteId);
                });
                editorTags.appendChild(tagElement);
            });

            // Add tag input
            const tagInput = document.createElement('input');
            tagInput.type = 'text';
            tagInput.className = 'editor-tag-input';
            tagInput.placeholder = 'Add tag...';
            tagInput.maxLength = 20;
            tagInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && tagInput.value.trim()) {
                    addTagToNote(tagInput.value.trim(), currentNoteId);
                    tagInput.value = '';
                }
            });
            editorTags.appendChild(tagInput);
        }

        // Close note editor
        function closeNoteEditor() {
            saveCurrentNote();
            editorContainer.classList.remove('active');
            currentNoteId = null;
        }

        // Save current note
        function saveCurrentNote() {
            if (!currentNoteId) return;

            const title = editorTitle.value.trim();
            const content = JSON.stringify(quill.getContents());
            const isPinned = pinNoteBtn.classList.contains('active');
            const isFavorite = favoriteNoteBtn.classList.contains('active');
            const now = new Date().toISOString();

            // Get tags from editor
            const tags = [];
            const tagElements = editorTags.querySelectorAll('.editor-tag');
            tagElements.forEach(tagEl => {
                tags.push(tagEl.textContent.replace('', '').trim());
            });

            // Don't save empty notes
            if (!title && content === '[{"insert":"\\n"}]') {
                // If it's an existing empty note, remove it
                const existingNoteIndex = notes.findIndex(n => n.id === currentNoteId);
                if (existingNoteIndex >= 0) {
                    notes.splice(existingNoteIndex, 1);
                }
                return;
            }

            const existingNoteIndex = notes.findIndex(n => n.id === currentNoteId);

            const noteData = {
                id: currentNoteId,
                title,
                content,
                tags,
                pinned: isPinned,
                favorite: isFavorite,
                color: currentNoteColor,
                trashed: false,
                createdAt: existingNoteIndex >= 0 ? notes[existingNoteIndex].createdAt : now,
                updatedAt: now,
                attachments: existingNoteIndex >= 0 ? notes[existingNoteIndex].attachments || [] : []
            };

            if (existingNoteIndex >= 0) {
                notes[existingNoteIndex] = noteData;
            } else {
                notes.unshift(noteData);
            }

            // Update tags count
            updateTagsCount();

            saveData();
            updateCounts();
            renderNotes(searchInput.value);
        }

        // Add tag to note
        function addTagToNote(tagName, noteId = currentNoteId) {
            if (!noteId) return;

            const noteIndex = notes.findIndex(n => n.id === noteId);
            if (noteIndex === -1) return;

            if (!notes[noteIndex].tags) {
                notes[noteIndex].tags = [];
            }

            if (!notes[noteIndex].tags.includes(tagName)) {
                notes[noteIndex].tags.push(tagName);

                // Add to tags list if not exists
                const tagIndex = tags.findIndex(t => t.name === tagName);
                if (tagIndex === -1) {
                    tags.push({
                        name: tagName,
                        count: 1
                    });
                } else {
                    tags[tagIndex].count++;
                }

                saveData();
                renderTags();

                // Add tag to editor UI
                const tagElement = document.createElement('div');
                tagElement.className = 'editor-tag';
                tagElement.innerHTML = `
                    ${tagName}
                    <span class="editor-tag-remove">&times;</span>
                `;
                tagElement.querySelector('.editor-tag-remove').addEventListener('click', () => {
                    removeTagFromNote(tagName, noteId);
                });

                const tagInput = editorTags.querySelector('.editor-tag-input');
                editorTags.insertBefore(tagElement, tagInput);
            }
        }

        // Remove tag from note
        function removeTagFromNote(tagName, noteId = currentNoteId) {
            if (!noteId) return;

            const noteIndex = notes.findIndex(n => n.id === noteId);
            if (noteIndex === -1) return;

            if (notes[noteIndex].tags) {
                notes[noteIndex].tags = notes[noteIndex].tags.filter(t => t !== tagName);

                // Update tags count
                const tagIndex = tags.findIndex(t => t.name === tagName);
                if (tagIndex !== -1) {
                    tags[tagIndex].count--;
                    if (tags[tagIndex].count <= 0) {
                        tags.splice(tagIndex, 1);
                    }
                }

                saveData();
                renderTags();

                // Remove tag from editor UI
                const tagElements = editorTags.querySelectorAll('.editor-tag');
                tagElements.forEach(tagEl => {
                    if (tagEl.textContent.replace('', '').trim() === tagName) {
                        tagEl.remove();
                    }
                });
            }
        }

        // Update tags count
        function updateTagsCount() {
            // Reset all counts
            tags.forEach(tag => {
                tag.count = 0;
            });

            // Count tags from notes
            notes.forEach(note => {
                if (note.tags && !note.trashed) {
                    note.tags.forEach(tagName => {
                        const tagIndex = tags.findIndex(t => t.name === tagName);
                        if (tagIndex !== -1) {
                            tags[tagIndex].count++;
                        } else {
                            tags.push({
                                name: tagName,
                                count: 1
                            });
                        }
                    });
                }
            });

            // Remove tags with zero count
            tags = tags.filter(tag => tag.count > 0);

            saveData();
            renderTags();
        }

        // Delete current note
        function deleteCurrentNote() {
            if (!currentNoteId) return;

            const noteIndex = notes.findIndex(n => n.id === currentNoteId);
            if (noteIndex === -1) return;

            if (notes[noteIndex].trashed) {
                // Permanent delete
                showConfirmation(
                    'Permanently Delete Note',
                    'Are you sure you want to permanently delete this note? This cannot be undone.',
                    'fas fa-trash',
                    () => {
                        notes.splice(noteIndex, 1);
                        closeNoteEditor();
                        saveData();
                        updateCounts();
                        renderNotes(searchInput.value);
                        showToast('Note permanently deleted', 'success');
                    }
                );
            } else {
                // Move to trash
                notes[noteIndex].trashed = true;
                closeNoteEditor();
                saveData();
                updateCounts();
                renderNotes(searchInput.value);
                showToast('Note moved to trash', 'success');
            }
        }

        // Duplicate current note
        function duplicateCurrentNote() {
            if (!currentNoteId) return;

            const noteIndex = notes.findIndex(n => n.id === currentNoteId);
            if (noteIndex === -1) return;

            showConfirmation(
                'Duplicate Note',
                'Are you sure you want to create a duplicate of this note?',
                'far fa-copy',
                () => {
                    const originalNote = notes[noteIndex];
                    const now = new Date().toISOString();

                    const duplicatedNote = {
                        id: generateId(),
                        title: originalNote.title ? `${originalNote.title} (Copy)` : 'Untitled Note (Copy)',
                        content: originalNote.content,
                        tags: [...(originalNote.tags || [])],
                        pinned: false,
                        favorite: false,
                        color: originalNote.color || 'default',
                        trashed: false,
                        createdAt: now,
                        updatedAt: now,
                        attachments: [...(originalNote.attachments || [])]
                    };

                    notes.unshift(duplicatedNote);
                    saveData();
                    updateCounts();
                    renderNotes(searchInput.value);
                    openNoteEditor(duplicatedNote.id);
                    showToast('Note duplicated', 'success');
                }
            );
        }

        // Toggle pin status
        function togglePinNote() {
            pinNoteBtn.classList.toggle('active');
            pinNoteBtn.innerHTML = pinNoteBtn.classList.contains('active') ?
                '<i class="fas fa-thumbtack"></i>' : '<i class="far fa-thumbtack"></i>';
            debounceSave();
        }

        // Toggle favorite status
        function toggleFavoriteNote() {
            favoriteNoteBtn.classList.toggle('active');
            favoriteNoteBtn.innerHTML = favoriteNoteBtn.classList.contains('active') ?
                '<i class="fas fa-star"></i>' : '<i class="far fa-star"></i>';
            debounceSave();
        }

        // Change note color
        function changeNoteColor(color) {
            currentNoteColor = color;
            editorContainer.className = `editor-container ${color !== 'default' ? 'note-color-' + color : ''}`;
            debounceSave();
        }

        // Update counts for sidebar
        function updateCounts() {
            allNotesCount.textContent = notes.filter(n => !n.trashed).length;
            pinnedNotesCount.textContent = notes.filter(n => n.pinned && !n.trashed).length;
            favoriteNotesCount.textContent = notes.filter(n => n.favorite && !n.trashed).length;
            trashNotesCount.textContent = notes.filter(n => n.trashed).length;
        }

        // Upload files
        function uploadFiles(fileList) {
            if (!fileList || fileList.length === 0) return;

            let filesProcessed = 0;
            let filesSkipped = 0;
            let filesUploaded = 0;

            Array.from(fileList).forEach(file => {
                // Check file size
                if (file.size > FILE_SIZE_LIMIT) {
                    showToast(`File "${file.name}" is too large (max ${formatFileSize(FILE_SIZE_LIMIT)})`, 'error');
                    filesSkipped++;
                    return;
                }

                // Check file type
                if (!ALLOWED_FILE_TYPES.includes(file.type)) {
                    showToast(`File type not supported: "${file.name}"`, 'error');
                    filesSkipped++;
                    return;
                }

                // Check for duplicate files
                const duplicateFile = files.find(f => f.name === file.name && f.size === file.size);
                if (duplicateFile) {
                    showToast(`File "${file.name}" already exists`, 'error');
                    filesSkipped++;
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    const fileData = {
                        id: generateId(),
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        data: e.target.result,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };

                    files.unshift(fileData);
                    filesProcessed++;
                    filesUploaded++;

                    if (filesProcessed === (fileList.length - filesSkipped)) {
                        saveData();
                        renderFiles();

                        if (filesUploaded > 0) {
                            showToast(`Uploaded ${filesUploaded} file(s)`, 'success');
                        }

                        if (filesSkipped > 0) {
                            showToast(`Skipped ${filesSkipped} file(s) due to restrictions`, 'warning');
                        }
                    }
                };

                reader.onerror = () => {
                    filesProcessed++;
                    showToast(`Error reading file "${file.name}"`, 'error');

                    if (filesProcessed === (fileList.length - filesSkipped)) {
                        if (filesUploaded > 0) {
                            saveData();
                            renderFiles();
                            showToast(`Uploaded ${filesUploaded} file(s)`, 'success');
                        }
                    }
                };

                reader.readAsArrayBuffer(file);
            });
        }

        // Download file
        function downloadFile(fileId) {
            const file = files.find(f => f.id === fileId);
            if (!file) return;

            const blob = new Blob([file.data], {
                type: file.type
            });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = file.name;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Delete file
        function deleteFile(fileId) {
            const fileIndex = files.findIndex(f => f.id === fileId);
            if (fileIndex === -1) return;

            const fileName = files[fileIndex].name;

            showConfirmation(
                'Delete File',
                `Are you sure you want to delete "${fileName}"?`,
                'fas fa-trash',
                () => {
                    files.splice(fileIndex, 1);
                    saveData();
                    renderFiles();
                    showToast('File deleted', 'success');
                }
            );
        }

        // Rename file
        function renameFile(fileId, newName) {
            const fileIndex = files.findIndex(f => f.id === fileId);
            if (fileIndex === -1) return;

            if (newName && newName.trim() && newName.trim() !== files[fileIndex].name) {
                // Check for duplicate names
                const duplicateFile = files.find(f => f.name === newName.trim() && f.id !== fileId);
                if (duplicateFile) {
                    showToast('A file with this name already exists', 'error');
                    return;
                }

                files[fileIndex].name = newName.trim();
                files[fileIndex].updatedAt = new Date().toISOString();
                saveData();
                renderFiles();
                showToast('File renamed', 'success');
            }
        }

        // Show confirmation dialog
        function showConfirmation(title, message, icon, confirmCallback) {
            confirmationTitle.textContent = title;
            confirmationMessage.textContent = message;
            confirmationIcon.className = icon;

            currentConfirmation = {
                confirm: confirmCallback
            };

            confirmationModal.classList.add('active');
        }

        // Show password modal
        function showPasswordModal() {
            passwordModalInput.value = '';
            passwordModal.classList.add('active');
            passwordModalInput.focus();
        }

        // Lock the app
        function lockApp() {
            if (!lockToggle.checked || !passwordInput.value) {
                showToast('Please enable password lock and set a password first', 'error');
                return;
            }

            isLocked = true;
            saveData();

            // Close all modals and editors
            editorContainer.classList.remove('active');
            settingsModal.classList.remove('active');
            filePreviewModal.classList.remove('active');
            confirmationModal.classList.remove('active');

            showToast('App locked', 'success');
            showPasswordModal();
        }

        // Unlock the app
        function unlockApp() {
            if (passwordModalInput.value === passwordInput.value) {
                isLocked = false;
                passwordModal.classList.remove('active');
                passwordModalInput.value = '';
                saveData();
                showToast('App unlocked', 'success');
            } else {
                showToast('Incorrect password', 'error');
                passwordModalInput.value = '';
            }
        }

        // Generate unique ID
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
        }

        // Generate encryption key
        function generateEncryptionKey() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*()';
            let key = '';
            for (let i = 0; i < 32; i++) {
                key += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return key;
        }

        // Update view based on current state
        function updateView() {
            switch (currentView) {
                case 'notes':
                    currentViewTitle.textContent = 'All Notes';
                    notesView.style.display = 'block';
                    filesView.style.display = 'none';
                    newNoteBtn.style.display = 'flex';
                    renderNotes();
                    break;
                case 'pinned':
                    currentViewTitle.textContent = 'Pinned Notes';
                    notesView.style.display = 'block';
                    filesView.style.display = 'none';
                    newNoteBtn.style.display = 'flex';
                    renderNotes();
                    break;
                case 'favorites':
                    currentViewTitle.textContent = 'Favorites';
                    notesView.style.display = 'block';
                    filesView.style.display = 'none';
                    newNoteBtn.style.display = 'flex';
                    renderNotes();
                    break;
                case 'trash':
                    currentViewTitle.textContent = 'Trash';
                    notesView.style.display = 'block';
                    filesView.style.display = 'none';
                    newNoteBtn.style.display = 'none';
                    renderNotes();
                    break;
                case 'files':
                    currentViewTitle.textContent = 'All Files';
                    notesView.style.display = 'none';
                    filesView.style.display = 'block';
                    newNoteBtn.style.display = 'none';
                    renderFiles();
                    break;
                case 'recent-files':
                    currentViewTitle.textContent = 'Recent Files';
                    notesView.style.display = 'none';
                    filesView.style.display = 'block';
                    newNoteBtn.style.display = 'none';
                    // Filter and show recent files
                    const recentFiles = files.sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt)).slice(0, 20);
                    renderFiles(recentFiles);
                    break;
                default:
                    if (currentView.startsWith('tag:')) {
                        const tagName = currentView.replace('tag:', '');
                        currentViewTitle.textContent = `Tag: ${tagName}`;
                        notesView.style.display = 'block';
                        filesView.style.display = 'none';
                        newNoteBtn.style.display = 'flex';
                        renderNotes();
                    } else {
                        currentViewTitle.textContent = 'All Notes';
                        notesView.style.display = 'block';
                        filesView.style.display = 'none';
                        newNoteBtn.style.display = 'flex';
                        renderNotes();
                    }
            }
        }

        // Show toast notification
        function showToast(message, type = 'info') {
            toastMessage.textContent = message;

            // Set icon based on type
            let icon = '';
            switch (type) {
                case 'success':
                    icon = '<i class="fas fa-check-circle"></i>';
                    toastIcon.innerHTML = icon;
                    toastIcon.className = 'toast-icon toast-success';
                    break;
                case 'error':
                    icon = '<i class="fas fa-exclamation-circle"></i>';
                    toastIcon.innerHTML = icon;
                    toastIcon.className = 'toast-icon toast-error';
                    break;
                case 'warning':
                    icon = '<i class="fas fa-exclamation-triangle"></i>';
                    toastIcon.innerHTML = icon;
                    toastIcon.className = 'toast-icon toast-warning';
                    break;
                default:
                    icon = '<i class="fas fa-info-circle"></i>';
                    toastIcon.innerHTML = icon;
                    toastIcon.className = 'toast-icon';
            }

            // Show toast
            toast.classList.remove('show', 'hide');
            void toast.offsetWidth; // Trigger reflow
            toast.classList.add('show');

            // Hide after delay
            setTimeout(() => {
                toast.classList.remove('show');
                toast.classList.add('hide');
            }, 3000);
        }

        // Check theme preference
        function checkThemePreference() {
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (prefersDark && themeSelector.value === 'light') {
                themeSelector.value = 'dark';
                updateTheme();
            }
        }

        // Update theme based on selector
        function updateTheme() {
            const theme = themeSelector.value;
            document.documentElement.setAttribute('data-theme', theme);

            if (theme === 'black') {
                document.body.classList.add('theme-black');
            } else {
                document.body.classList.remove('theme-black');
            }

            saveData();
        }

        // Reset app data
        function resetAppData() {
            showConfirmation(
                'Reset All Data',
                'Are you sure you want to reset all app data? This will permanently delete all notes, files, and settings.',
                'fas fa-trash',
                () => {
                    notes = [];
                    files = [];
                    tags = [];

                    try {
                        localStorage.removeItem('notedecs-notes');
                        localStorage.removeItem('notedecs-files');
                        localStorage.removeItem('notedecs-tags');
                        localStorage.removeItem('notedecs-settings');
                    } catch (e) {
                        console.error('Error clearing storage:', e);
                    }

                    updateCounts();
                    renderNotes();
                    renderFiles();
                    renderTags();
                    checkThemePreference();

                    // Reset settings UI
                    lockToggle.checked = false;
                    passwordInputContainer.style.display = 'none';
                    encryptionToggle.checked = false;
                    encryptionKeyContainer.style.display = 'none';
                    cleanPasteToggle.checked = false;
                    document.body.style.fontSize = '16px';
                    fontSizeValue.textContent = '16px';

                    showToast('All data has been reset', 'success');
                }
            );
        }

        // Debounce save function
        let saveTimeout;

        function debounceSave() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(saveCurrentNote, parseInt(autosaveInterval.value) * 1000);
        }

        // Setup event listeners
        function setupEventListeners() {
            // Permission modal
            grantPermissionBtn.addEventListener('click', () => {
                permissionModal.classList.remove('active');
                hasStorageAccess = true;
                loadingScreen.classList.remove('hidden');
                initQuill();
                checkExistingData();
            });

            denyPermissionBtn.addEventListener('click', () => {
                permissionModal.classList.remove('active');
                loadingScreen.querySelector('.loading-text').textContent = 'Permission required to use the app';
                setTimeout(() => {
                    permissionModal.classList.add('active');
                }, 2000);
            });

            // Sidebar toggle
            sidebarToggle.addEventListener('click', () => {
                sidebar.classList.add('active');
                workspace.classList.add('with-sidebar');
            });

            sidebarCloseBtn.addEventListener('click', () => {
                sidebar.classList.remove('active');
                workspace.classList.remove('with-sidebar');
            });

            // Sidebar navigation
            document.querySelectorAll('.sidebar-item[data-view]').forEach(item => {
                item.addEventListener('click', () => {
                    currentView = item.dataset.view;
                    updateView();
                    sidebar.classList.remove('active');
                    workspace.classList.remove('with-sidebar');
                });
            });

            // Add tag button
            addTagBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const tagName = prompt('Enter new tag name:');
                if (tagName && tagName.trim()) {
                    const existingTag = tags.find(t => t.name === tagName.trim());
                    if (!existingTag) {
                        tags.push({
                            name: tagName.trim(),
                            count: 0
                        });
                        saveData();
                        renderTags();
                        showToast(`Tag "${tagName}" created`, 'success');
                    } else {
                        showToast('Tag already exists', 'error');
                    }
                }
            });

            // Note actions
            newNoteBtn.addEventListener('click', () => openNoteEditor());
            editorBackBtn.addEventListener('click', closeNoteEditor);

            // Color picker
            colorPickerBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                colorPicker.style.display = colorPicker.style.display === 'none' ? 'flex' : 'none';
            });

            document.addEventListener('click', (e) => {
                if (e.target !== colorPickerBtn && !colorPicker.contains(e.target)) {
                    colorPicker.style.display = 'none';
                }
            });

            // Color selection
            document.querySelectorAll('.color-option').forEach(option => {
                option.addEventListener('click', () => {
                    document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
                    option.classList.add('selected');
                    changeNoteColor(option.dataset.color);
                });
            });

            // Emoji picker
            emojiPickerBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                emojiPicker.style.display = emojiPicker.style.display === 'none' ? 'block' : 'none';

                // Position the emoji picker
                const rect = emojiPickerBtn.getBoundingClientRect();
                emojiPicker.style.left = `${rect.left}px`;
                emojiPicker.style.top = `${rect.bottom + 5}px`;
            });

            document.addEventListener('click', (e) => {
                if (e.target !== emojiPickerBtn && !emojiPicker.contains(e.target)) {
                    emojiPicker.style.display = 'none';
                }
            });

            pinNoteBtn.addEventListener('click', togglePinNote);
            favoriteNoteBtn.addEventListener('click', toggleFavoriteNote);
            attachFileBtn.addEventListener('click', () => fileUploadInput.click());
            duplicateNoteBtn.addEventListener('click', duplicateCurrentNote);
            deleteNoteBtn.addEventListener('click', deleteCurrentNote);
            markdownToggleBtn.addEventListener('click', toggleMarkdownMode);

            // Auto-save on change with debounce
            editorTitle.addEventListener('input', debounceSave);

            // Search functionality
            searchBtn.addEventListener('click', () => {
                searchContainer.style.display = 'block';
                searchInput.focus();
            });

            closeSearchBtn.addEventListener('click', () => {
                searchContainer.style.display = 'none';
                searchInput.value = '';
                renderNotes();
            });

            searchInput.addEventListener('input', (e) => renderNotes(e.target.value));

            // Settings
            settingsBtn.addEventListener('click', () => settingsModal.classList.add('active'));
            settingsCloseBtn.addEventListener('click', () => settingsModal.classList.remove('active'));
            themeSelector.addEventListener('change', updateTheme);

            lockToggle.addEventListener('change', () => {
                passwordInputContainer.style.display = lockToggle.checked ? 'flex' : 'none';
                saveData();
            });

            encryptionToggle.addEventListener('change', () => {
                if (encryptionToggle.checked) {
                    const key = generateEncryptionKey();
                    encryptionKey.textContent = key;
                    encryptionKeyContainer.style.display = 'flex';

                    showConfirmation(
                        'Enable Encryption',
                        'This will encrypt all your notes. Save this key in a secure place as you will need it to decrypt your notes. Without it, your data will be permanently inaccessible.',
                        'fas fa-key',
                        () => {
                            showToast('Encryption enabled. Save your encryption key!', 'success');
                            saveData();
                        }
                    );
                } else {
                    showConfirmation(
                        'Disable Encryption',
                        'This will decrypt all your notes. Are you sure you want to proceed?',
                        'fas fa-key',
                        () => {
                            encryptionKeyContainer.style.display = 'none';
                            showToast('Encryption disabled', 'info');
                            saveData();
                        }
                    );
                }
            });

            encryptionKey.addEventListener('click', () => {
                navigator.clipboard.writeText(encryptionKey.textContent)
                    .then(() => showToast('Encryption key copied to clipboard', 'success'))
                    .catch(() => showToast('Failed to copy key', 'error'));
            });

            // Clean paste toggle
            cleanPasteToggle.addEventListener('change', () => {
                if (cleanPasteToggle.checked) {
                    enableCleanPaste();
                } else {
                    disableCleanPaste();
                }
                saveData();
            });

            // Font size controls
            fontDecreaseBtn.addEventListener('click', () => {
                let size = parseInt(document.body.style.fontSize || '16');
                if (size > 12) {
                    size -= 2;
                    document.body.style.fontSize = `${size}px`;
                    fontSizeValue.textContent = `${size}px`;
                    saveData();
                }
            });

            fontIncreaseBtn.addEventListener('click', () => {
                let size = parseInt(document.body.style.fontSize || '16');
                if (size < 24) {
                    size += 2;
                    document.body.style.fontSize = `${size}px`;
                    fontSizeValue.textContent = `${size}px`;
                    saveData();
                }
            });

            resetAppBtn.addEventListener('click', resetAppData);
            lockAppBtn.addEventListener('click', lockApp);

            // Password modal
            passwordSubmitBtn.addEventListener('click', unlockApp);
            passwordCancelBtn.addEventListener('click', () => {
                passwordModal.classList.remove('active');
                passwordModalInput.value = '';
            });

            passwordModalInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    unlockApp();
                }
            });

            // Confirmation modal
            confirmationCancelBtn.addEventListener('click', () => {
                confirmationModal.classList.remove('active');
                currentConfirmation = null;
            });

            confirmationConfirmBtn.addEventListener('click', () => {
                if (currentConfirmation && currentConfirmation.confirm) {
                    currentConfirmation.confirm();
                }
                confirmationModal.classList.remove('active');
                currentConfirmation = null;
            });

            // File upload
            uploadFileBtn.addEventListener('click', () => fileUploadInput.click());
            fileUploadInput.addEventListener('change', (e) => {
                uploadFiles(e.target.files);
                e.target.value = ''; // Reset input
            });

            // File preview
            filePreviewClose.addEventListener('click', () => {
                filePreviewModal.classList.remove('active');
                currentPreviewFileId = null;
            });

            filePreviewDownload.addEventListener('click', () => {
                if (currentPreviewFileId) {
                    downloadFile(currentPreviewFileId);
                }
            });

            // Close modals when clicking outside
            window.addEventListener('click', (e) => {
                if (e.target === settingsModal) {
                    settingsModal.classList.remove('active');
                }

                if (e.target === passwordModal) {
                    passwordModal.classList.remove('active');
                    passwordModalInput.value = '';
                }

                if (e.target === confirmationModal) {
                    confirmationModal.classList.remove('active');
                    currentConfirmation = null;
                }

                if (e.target === filePreviewModal) {
                    filePreviewModal.classList.remove('active');
                    currentPreviewFileId = null;
                }
            });
        }

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
    <script>
        // Add this function to your JavaScript code, preferably near other similar functions
        function toggleMarkdownMode() {
            isMarkdownMode = !isMarkdownMode;
            markdownToggleBtn.textContent = isMarkdownMode ? 'Rich Text Mode' : 'Markdown Mode';

            if (isMarkdownMode) {
                // Convert to markdown
                const content = quill.getContents();
                let markdown = '';

                content.ops.forEach(op => {
                    if (op.insert) {
                        let text = op.insert;

                        if (op.attributes) {
                            if (op.attributes.bold) text = `**${text}**`;
                            if (op.attributes.italic) text = `*${text}*`;
                            if (op.attributes.underline) text = `_${text}_`;
                            if (op.attributes.header) {
                                const level = op.attributes.header;
                                text = `${'#'.repeat(level)} ${text}\n`;
                            }
                            if (op.attributes.list) {
                                const listType = op.attributes.list;
                                text = listType === 'ordered' ? `1. ${text}\n` : `- ${text}\n`;
                            }
                        }

                        markdown += text;
                    }
                });

                quill.setContents([{
                    insert: markdown
                }]);
            } else {
                // Convert back to rich text
                const markdown = quill.getText();
                const delta = {
                    ops: []
                };

                // Simple conversion for demonstration
                const lines = markdown.split('\n');
                lines.forEach(line => {
                    if (line.startsWith('### ')) {
                        delta.ops.push({
                            insert: line.substring(4) + '\n',
                            attributes: {
                                header: 3
                            }
                        });
                    } else if (line.startsWith('## ')) {
                        delta.ops.push({
                            insert: line.substring(3) + '\n',
                            attributes: {
                                header: 2
                            }
                        });
                    } else if (line.startsWith('# ')) {
                        delta.ops.push({
                            insert: line.substring(2) + '\n',
                            attributes: {
                                header: 1
                            }
                        });
                    } else if (line.startsWith('**') && line.endsWith('**')) {
                        delta.ops.push({
                            insert: line.substring(2, line.length - 2),
                            attributes: {
                                bold: true
                            }
                        });
                    } else if (line.startsWith('*') && line.endsWith('*')) {
                        delta.ops.push({
                            insert: line.substring(1, line.length - 1),
                            attributes: {
                                italic: true
                            }
                        });
                    } else if (line.startsWith('_') && line.endsWith('_')) {
                        delta.ops.push({
                            insert: line.substring(1, line.length - 1),
                            attributes: {
                                underline: true
                            }
                        });
                    } else if (line.startsWith('- ')) {
                        delta.ops.push({
                            insert: line.substring(2) + '\n',
                            attributes: {
                                list: 'bullet'
                            }
                        });
                    } else if (/^\d+\. /.test(line)) {
                        delta.ops.push({
                            insert: line.replace(/^\d+\. /, '') + '\n',
                            attributes: {
                                list: 'ordered'
                            }
                        });
                    } else {
                        delta.ops.push({
                            insert: line + '\n'
                        });
                    }
                });

                quill.setContents(delta.ops);
            }
        }
    </script>
</body>

</html>